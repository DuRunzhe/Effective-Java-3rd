# 审慎地使用本地方法

Java程序可以通过`Java Native Interface（JNI）`调用本地方法，本地方法指的是通过本地编程语言如C或是C++来编写的方法。从历史上来看，本地方法有3个主要的应用场景。他们提供了对特定于平台功能如寄存器的访问；提供了对既有的本地代码库的访问，包括提供了对遗留数据访问的遗留库。最后，本地方法用于以本地语言编写应用中性能关键的部分以改进性能。

使用本地方法访问特定于平台的功能是合情合理的，不过极少需要这么做：随着`Java`平台的 不断成熟，它提供了对之前只有在宿主平台才有的很多特性的访问能力。比如说，`Java 9`新增的进程API就提供了对OS进程的访问能力。当`Java`中不存在相应的库时，通过本地方法来 使用本地库也是合理的。

**一般不建议通过本地方法来改进性能。**在`Java`的早期版本中（`Java 3`之前），这么做常常是必要的，不过从那以后，`JVM`的运行速度快了很多。对于大多数任务来说，`Java`也可以获得与本地方法相当的性能。比如说，在`java.math`添加到`1.1`版时，`BigInteger`依赖于使用`C`所编写的速度更快的多精度算法库。在`Java 3`中，`BigInteger`使用`Java`进行了重新实现，并且进行了细致的调优，使得其运行速度要比之前的本地实现还要快。

遗憾的是，从那以后，`BigInteger`就没什么变化。除了在`Java 8`中，对于大数的相乘速度有所提高。在此期间，在本地方法库上的工作继续快速进行着，尤其是`GNU`多精度算术库（`GMP`）。需要真正高性能多精度算法的`Java`程序员现在可以通过本地方法使用`GMP` [Blum14]。

使用本地方法有严重的缺点。由于本地语言不安全（条款50），使用本地方法的应用程序不再对内存损坏错误免疫。由于本地语言比`Java`更依赖于平台，因此使本地方法的程序可移植性较差。本地方法也更难调试。
如果不小心，本地方法可能会降低性能，因为垃圾收集器无法自动化甚至跟踪本地内存的使用（条款8），而且还有本地代码进出的成本。最后，本地方法需要“胶水代码”，读起来很困难，写起来也很繁琐。

总之，在使用本地方法之前要三思。你很少需要使用它们来提高性能。如果你必须使用本地方法来访问底层资源或本地库，则应尽可能少地使用本地代码并对其进行完整地测试。本地代码中的一个错误就可以破坏整个应用程序。